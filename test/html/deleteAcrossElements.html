<!doctype html>
<html>
<meta charset="UTF-8">
<head>

  <title>Delete across elements Test</title>

  <!-- base functionality-->
  <script src="../../../platform/platform.js"></script>
  <!-- common infrastructure -->
  <link rel="import" href="preamble.html">
  <!-- test specific imports -->
  <link rel="import" href="../elements/utils-event.html">
  <link rel="import" href="../elements/utils-keyboard.html">
  <link rel="import" href="../elements/utils-text.html">
  <link rel="import" href="../elements/utils-keys.html">
  <link rel="import" href="../../elements/x-html-p.html">
  <link rel="import" href="../../elements/x-html-span.html">

</head>
<body>

  <h3>Delete across elements</h3>
  <p>
    This page tests the ability to delete across elements, including the
    behaviour of merging line elements between paragraphs.
  </p>

  <hr/>

  <polymer-editor id="my-editor">
    <polymer-editor-content>
      <x-html-p>
        <x-html-span>hello</x-html-span><x-html-span>world</x-html-span>
      </x-html-p><x-html-p>
      <x-html-span>something else</x-html-span>
    </x-html-p>
  </polymer-editor-content></polymer-editor>

  <script type="text/javascript" charset="utf-8">

    addEventListener('polymer-ready', function() {
      var assert = chai.assert;

      // modularized apis
      var EventUtils = document.createElement('utils-event').api;
      var Keyboard = document.createElement('utils-keyboard').api;
      var Text = document.createElement('utils-text').api;
      var Keys = document.createElement('utils-keys').api;

      function placeCaret(node, offset) {
        var range = document.createRange();
        range.setStart(node, offset);
        range.setEnd(node, offset);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
      }

      var editorContent = document.querySelector('polymer-editor-content');
      var paras = editorContent.querySelectorAll('x-html-p');
      var spans = editorContent.querySelectorAll('x-html-span');

      // delete from 2nd span in to 1st span
      placeCaret(spans[1].firstChild, 2);
      Keyboard.type(Keys("⟵").repeat(4))
        .then(function(a) {

        assert.equal(paras[0].innerText, 'helrld');
      }).then(function() {

        // test merging one span in to the previous paragraphs
        placeCaret(spans[2].firstChild, 0);
        return Keyboard.type(Keys("⟵"));
      }).then(function() {
        assert.equal(paras[0].innerText, 'helrldsomething else');
        var newParas = document.querySelectorAll('x-html-p');
        assert.equal(newParas.length, paras.length -1);
      })
      .then(done)
      .catch(onerror);
    });

  </script>
</body>
</html>
