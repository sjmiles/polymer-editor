<!doctype html>
<html>
<meta charset="UTF-8">
<head>
  <title>Basic Test</title>
  <!-- base functionality-->
  <script src="../../../platform/platform.js"></script>
  <!-- common infrastructure -->
  <link rel="import" href="preamble.html">
  <!-- test specific imports -->
  <link rel="import" href="../elements/utils-event.html">
  <link rel="import" href="../elements/utils-keyboard.html">
  <link rel="import" href="../elements/utils-text.html">
  <link rel="import" href="../elements/utils-keys.html">
</head>
<body>

  <h3>Basic text insert and delete</h3>
  <p>
    This page tests the basics of &lt;polymer-editor&gt;, in particular
    it inserts text at the start, middle and end of existing text. and also
    verifies that backspace within text will delete characters.
  </p>
  <hr/>

  <polymer-editor id="my-editor">
    <polymer-editor-content>hello</polymer-editor-content>
  </polymer-editor>

  <script type="text/javascript" charset="utf-8">
    addEventListener('polymer-ready', function() {

      var assert = chai.assert;

      // modularized apis
      var EventUtils = document.createElement('utils-event').api;
      var Keyboard = document.createElement('utils-keyboard').api;
      var Text = document.createElement('utils-text').api;
      var Keys = document.createElement('utils-keys').api;

      // hard codes the element placement based on above html
      function placeCaret(offset) {
        var editor = document.querySelector('#my-editor');
        var content = editor.firstElementChild;
        var contentTextNode = content.firstChild;
        var range = document.createRange();
        range.setStart(contentTextNode, offset);
        range.setEnd(contentTextNode, offset);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
      }

      // make sure we have an editor - should probably test more than
      // just the fact the element is defined... ?
      var editor = document.querySelector('#my-editor');
      var editorContent = document.querySelector('polymer-editor-content');
      assert.isDefined(editor, 'our editor is defined');

      // test insert text at start
      placeCaret(0);
      Keyboard.type(Text('foobar')).then(function(a) {
        assert.equal(editorContent.innerText, 'foobarhello');
      }).then(function() {
        // test insert text in the middle
        placeCaret(6);
        return Keyboard.type(Text('eggs'));
      }).then(function() {
        assert.equal(editorContent.innerText, 'foobareggshello');
      }).then(function() {

        // test insert text at the end
        placeCaret(editorContent.innerText.length);
        return Keyboard.type(Text('world'));
      }).then(function() {
        assert.equal(editorContent.innerText, 'foobareggshelloworld');
      }).then(function() {

        // test backspace
        placeCaret(6);
        return Keyboard.type(Keys("⟵").repeat(6));
      }).then(function() {
        assert.equal(editorContent.innerText, 'eggshelloworld');
      })
      .then(done)
      .catch(onerror);
    });
  </script>
</body>
</html>
